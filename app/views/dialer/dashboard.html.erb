<div class="row">
  <div class="col-12">
    <h1 class="mb-4">
      <i class="fas fa-chart-line"></i> Dashboard & Call Logs
    </h1>
  </div>
</div>

<!-- Statistics Overview -->
<div class="row">
  <div class="col-md-2">
    <div class="card stat-card stat-card--info">
      <h3><%= @stats[:total_phone_numbers] %></h3>
      <p>Total Numbers</p>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card stat-card stat-card--warning">
      <h3><%= @stats[:pending] %></h3>
      <p>Pending</p>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card stat-card stat-card--primary">
      <h3><%= @stats[:total_calls] %></h3>
      <p>Total Calls</p>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card stat-card stat-card--success">
      <h3><%= @stats[:successful_calls] %></h3>
      <p>Answered</p>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card stat-card stat-card--danger">
      <h3><%= @stats[:failed_calls] %></h3>
      <p>Failed</p>
    </div>
  </div>
  <div class="col-md-2">
    <div class="card stat-card stat-card--neutral">
      <h3><%= @stats[:average_call_duration].round %>s</h3>
      <p>Avg Duration</p>
    </div>
  </div>
</div>

<!-- Call Status Distribution -->
<div class="row mt-4">
  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-chart-pie"></i> Call Status Distribution</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive phone-table-wrapper">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Status</th>
                <th>Count</th>
                <th>Percentage</th>
              </tr>
            </thead>
            <tbody>
              <% total = @calls_by_status.values.sum %>
              <% @calls_by_status.each do |status, count| %>
                <tr>
                  <td>
                    <span class="badge bg-secondary"><%= status %></span>
                  </td>
                  <td><%= count %></td>
                  <td>
                    <%= total > 0 ? ((count.to_f / total * 100).round(1)) : 0 %>%
                    <div class="progress mt-2">
                      <div class="progress-bar" style="width: <%= total > 0 ? (count.to_f / total * 100) : 0 %>%"></div>
                    </div>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-phone-alt"></i> Active Calls</h5>
      </div>
      <div class="card-body">
        <% active_calls = @recent_calls.select { |c| c.status.in?(['queued', 'ringing', 'in-progress']) } %>
        <% if active_calls.any? %>
          <ul class="list-group">
            <% active_calls.each do |call| %>
              <li class="list-group-item">
                <div class="d-flex justify-content-between align-items-center">
                  <div>
                    <strong><%= call.phone_number.formatted_number %></strong>
                    <br>
                    <small class="text-muted"><%= time_ago_in_words(call.created_at) %> ago</small>
                  </div>
                  <span class="badge bg-<%= call.status_color %> pulse">
                    <%= call.status_label %>
                  </span>
                </div>
              </li>
            <% end %>
          </ul>
        <% else %>
          <p class="text-muted text-center">No active calls</p>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Recent Call Logs -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-list"></i> Recent Call Logs</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive phone-table-wrapper">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Time</th>
                <th>Phone Number</th>
                <th>Name</th>
                <th>Status</th>
                <th>Duration</th>
                <th>Type</th>
                <th>Twilio SID</th>
              </tr>
            </thead>
            <tbody>
              <% @recent_calls.each do |call| %>
                <tr>
                  <td>
                    <small><%= call.created_at.strftime('%Y-%m-%d %H:%M:%S') %></small>
                  </td>
                  <td>
                    <strong><%= call.phone_number.formatted_number %></strong>
                  </td>
                  <td>
                    <%= call.phone_number.name || '-' %>
                  </td>
                  <td>
                    <span class="badge bg-<%= call.status_color %>">
                      <%= call.status_label %>
                    </span>
                  </td>
                  <td>
                    <%= call.duration ? "#{call.duration}s" : '-' %>
                  </td>
                  <td>
                    <small><%= call.call_type %></small>
                  </td>
                  <td>
                    <small class="text-muted"><%= call.twilio_call_sid %></small>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- Phone Numbers List -->
<div class="row mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5><i class="fas fa-address-book"></i> All Phone Numbers</h5>
      </div>
      <div class="card-body">
        <div class="table-responsive phone-table-wrapper">
          <table class="table table-hover align-middle">
            <thead>
              <tr>
                <th>Number</th>
                <th>Name</th>
                <th>Status</th>
                <th>Call Attempts</th>
                <th>Last Called</th>
                <th>Type</th>
                <th>Stats</th>
              </tr>
            </thead>
            <tbody>
              <% @phone_numbers.each do |phone| %>
                <tr>
                  <td><strong><%= phone.formatted_number %></strong></td>
                  <td><%= phone.name || '-' %></td>
                  <td>
                    <span class="badge bg-<%= phone.status == 'pending' ? 'warning' : phone.status == 'completed' ? 'success' : 'danger' %>">
                      <%= phone.status %>
                    </span>
                  </td>
                  <td><%= phone.call_attempts %></td>
                  <td>
                    <small>
                      <%= phone.last_called_at ? time_ago_in_words(phone.last_called_at) + ' ago' : 'Never' %>
                    </small>
                  </td>
                  <td>
                    <% if phone.is_test_number %>
                      <span class="badge bg-info">Test</span>
                    <% elsif phone.real_number? %>
                      <span class="badge bg-warning">Real</span>
                    <% else %>
                      <span class="badge bg-secondary">Normal</span>
                    <% end %>
                  </td>
                  <td>
                    <small>
                      <% stats = phone.call_stats %>
                      <%= stats[:total_calls] %> calls,
                      <%= stats[:completed] %> completed
                    </small>
                  </td>
                </tr>
              <% end %>
            </tbody>
          </table>
        </div>

        <% total = @phone_numbers_total || 0 %>
        <% visible_count = @phone_numbers.size %>
        <% start_index = total.positive? && visible_count.positive? ? ((@page - 1) * @per_page) + 1 : 0 %>
        <% end_index = total.positive? && visible_count.positive? ? start_index + visible_count - 1 : 0 %>

        <div class="d-flex flex-column flex-md-row justify-content-between align-items-center gap-3 mt-3">
          <small class="text-muted">
            <% if total.positive? %>
              Showing <%= start_index %> â€“ <%= end_index %> of <%= total %> numbers
            <% else %>
              No phone numbers available
            <% end %>
          </small>

          <% if @total_pages > 1 %>
            <nav aria-label="Phone numbers pagination">
              <ul class="pagination pagination-sm mb-0">
                <li class="page-item <%= 'disabled' if @page == 1 %>">
                  <%= link_to 'Prev', dashboard_path(page: [@page - 1, 1].max), class: 'page-link', tabindex: (@page == 1 ? -1 : nil) %>
                </li>

                <% window_start = [@page - 2, 1].max %>
                <% window_end = [@page + 2, @total_pages].min %>

                <% if window_start > 1 %>
                  <li class="page-item">
                    <%= link_to 1, dashboard_path(page: 1), class: 'page-link' %>
                  </li>
                  <% if window_start > 2 %>
                    <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                  <% end %>
                <% end %>

                <% (window_start..window_end).each do |page_number| %>
                  <li class="page-item <%= 'active' if page_number == @page %>">
                    <%= link_to page_number, dashboard_path(page: page_number), class: 'page-link', aria: { current: (page_number == @page ? 'page' : nil) } %>
                  </li>
                <% end %>

                <% if window_end < @total_pages %>
                  <% if window_end < @total_pages - 1 %>
                    <li class="page-item disabled"><span class="page-link">&hellip;</span></li>
                  <% end %>
                  <li class="page-item">
                    <%= link_to @total_pages, dashboard_path(page: @total_pages), class: 'page-link' %>
                  </li>
                <% end %>

                <li class="page-item <%= 'disabled' if @page == @total_pages %>">
                  <%= link_to 'Next', dashboard_path(page: [@page + 1, @total_pages].min), class: 'page-link', tabindex: (@page == @total_pages ? -1 : nil) %>
                </li>
              </ul>
            </nav>
          <% end %>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Auto-refresh every 10 seconds
  setTimeout(() => {
    location.reload();
  }, 10000);
</script>
